#!/usr/bin/env node

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’è¨­å®š
 * 2. npm run db:setup ã¾ãŸã¯ node scripts/setup-database.js
 */

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

console.log("ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™...");

// 1. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
const envFilePath = path.join(__dirname, "..", ".env.local");
if (!fs.existsSync(envFilePath)) {
  console.error("âŒ .env.localãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  console.log("ğŸ“ ä»¥ä¸‹ã®å†…å®¹ã§.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„:");
  console.log(`
# NextAuth.jsè¨­å®š
NEXTAUTH_SECRET=your_nextauth_secret_here
NEXTAUTH_URL=http://localhost:3000

# Google OAuthè¨­å®š  
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DATABASE_URL="postgresql://username:password@localhost:5432/subscription_manager"
POSTGRES_PRISMA_URL="postgresql://username:password@localhost:5432/subscription_manager"
POSTGRES_URL_NON_POOLING="postgresql://username:password@localhost:5432/subscription_manager"
  `);
  process.exit(1);
}

try {
  // 2. Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
  console.log("ğŸ“¦ Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­...");
  execSync("npx prisma generate", { stdio: "inherit" });

  // 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
  console.log("ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ä¸­...");
  execSync("npx prisma db push", { stdio: "inherit" });

  // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
  console.log("ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...");
  execSync("npx prisma studio --browser none &", { stdio: "pipe" });

  console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
  console.log("");
  console.log("ğŸ‰ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:");
  console.log("1. npm run dev ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•");
  console.log("2. npx prisma studio ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹GUIã‚’ç¢ºèª");
  console.log("3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ†ã‚¹ãƒˆ");
} catch (error) {
  console.error("âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error.message);
  console.log("");
  console.log("ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:");
  console.log("1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª");
  console.log("2. .env.localã®æ¥ç¶šæƒ…å ±ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª");
  console.log("3. PostgreSQLã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª");
  process.exit(1);
}
